angular.module('vnVisionDocumentManagementModule', [],function () {})
.run(function( vnAppManagementFactory ){
	var APP_ID 			= "VN_DOCMAN";
	var DOCUMENT_INBOX = APP_ID + '__DOCUMENT_INBOX';

	vnAppManagementFactory.registerApp( 
		{ id: APP_ID, 
		name: "Documents",
		icon: "images/scanned_doc.svg",
		screens: [
			DOCUMENT_INBOX
		]});
})
.factory( 'vnVisionDocumentManagementFactory', function(){
    var factory = {};

    
})
.controller('vnVisionDocumentManagementController', function( 
	$scope, 
	$rootScope,
	visionFactory, 
	vnScrollFactory, 
	vnNavigationFactory, 
	vnScreenManagementFactory ){

	var documentScroller;

	var item1 = {};
	item1.item = database[ CLINICAL_DOCS ].name;
	item1.count = 3;


	var item2 = {};
	item2.item = database[ PATIENT ].name;
	item2.count = 100;

	visionFactory.retrieveDataWithJoin( [ item1, item2 ], ["patientid", "Id"],
		function( results ){
			retrieveDocumentsHandler( results );
		}
	);

	/*visionFactory.retrieveData( database[ CLINICAL_DOCS ].name, function( results ){
		retrieveDocumentsHandler( results );
	}, null, null, 3);*/

	$( window ).resize(function() {
        handleResize();
      });

	var retrieveDocumentsHandler = function( results ){
		angular.forEach( results, function( value, index ){
			value.name = value.name.split( "." )[0];
		});
		$scope.documents = results;
		handleResize();
	};

	var handleResize = function(){
      //if( $scope.screens[ VN_TASK_SCREENS.HOME ] ){
        vnScrollFactory.handleResize( "document-scroller" );
        getInboxScroller().css( "height", "100vh" );
      //}
    };

    var getInboxScroller = function(){
    	if( documentScroller == null ){
    		documentScroller = $( ".document-scroller" );
    	}
    	return documentScroller;
    }

    $scope.handleBackButton = function(){
    	vnNavigationFactory.switchScreens( vnNavigationFactory.retrieveScreenFromHistory( vnNavigationFactory.SCREEN_PREVIOUS ) );
    	vnScreenManagementFactory.overrideGeneralClick = false;
     };

    $rootScope.$on( "COMMAND_SELECTED", function( name, id ){
    	if( id == DOCTSK ){
    		var attachedDocument;
    		vnScreenManagementFactory.toggleBars( true );
    		for( var i = 0; i < $scope.documents.length; i++ ){
	     		if( $scope.documents[i].selected == true ){
	     			attachedDocument = $scope.documents[i];
	     			$scope.documents[i].selected = false;
	     		}
	     	}
	     	$scope.handleBackButton();
	     	$rootScope.$broadcast( "DOCUMENT_ATTACHMENT", attachedDocument );
	     	vnScreenManagementFactory.overrideGeneralClick = false;
	     	
    	}
    } );

     $scope.handleDocumentClicked = function(){
     	if( this.item.selected == null ){
     		this.item.selected = false;
     		vnScreenManagementFactory.overrideGeneralClick = true;
     	}

     	this.item.selected = !this.item.selected;

     	var openTheCommandBar = false;
     	for( var i = 0; i < $scope.documents.length; i++ ){
     		if( $scope.documents[i].selected == true ){
     			openTheCommandBar = true
     			break;
     		}
     	}
     	if( openTheCommandBar ){
     		vnScreenManagementFactory.initialiseMenuOptions( null, selectRightCommands );
     		vnScreenManagementFactory.openCommandBar();
     	}else{
     		vnScreenManagementFactory.toggleBars( true );
     	}
     	
     	
     };

})
.directive('vnVisionDocumentManagement', function() {
    return {
      restrict: 'E',
      templateUrl: 'apps/visiondocumentmanagement/vndocumentmanagement.html'
    };
  })
.value('VN_DOCMAN_SCREENS',  { 
	DOCUMENT_INBOX: "VN_DOCMAN__DOCUMENT_INBOX"
});


