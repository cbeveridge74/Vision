angular.module('vnTaskModule', [],function () {})
.controller('vnTaskController', function ( 
	$scope, 
	$rootScope,
	visionFactory, 
	vnActionFactory,
	vnTaskFactory,
	vnScreenManagementFactory,
	vnNavigationFactory,
	vnActivitiServiceFactory
	) {
	$scope.init = function ( callback ) {
		$rootScope.$watch( $scope.screenToWatch, function( value ){
			if( value ){
				handleShow();
	    	}
      	});
		vnTaskFactory.registerTaskEventListener( vnTaskFactory.TASK_UPDATED, function( event, task ){
			handleTaskUpdated( task );
	 	});

	 	
	    
	};

	var handleTaskUpdated = function( task ){
		angular.forEach( task.assignee, function( value, index ){
 			if( $rootScope.user.id == value ){
 				vnTaskFactory.retrieveTasksFor( $rootScope.user.id, handleTasksRetrieved );
 			}
 		});
	};

	

	var handleShow = function(){
		vnTaskFactory.retrieveTasksFor( $rootScope.user.id, handleTasksRetrieved );
	};

	$scope.handleRightClick = function( event, element ){
		vnScreenManagementFactory.handleItemClick( event, element, {}, taskRightCommands, true );
	};

	$scope.handlePatientClick = function( event ){
        visionFactory.handlePatientClick( this.item.patient.id );
        event.stopPropagation();
	};

	$scope.handleAddClick = function( event ){
		if( !vnScreenManagementFactory.isDoubleClick() ){
			//vnNavigationFactory.switchScreens( 'home', 'taskform' );
			
		}
	};

	$scope.handleCardClick = function(){
		if( !vnScreenManagementFactory.isDoubleClick() ){
			vnActionFactory.needHelpWith( { name: this.item.subject.actiontypeid }, [this.item.patient.Id], function(){
	 			
	 		});
		}
	};

	var handleTasksRetrieved = function( tasks ){
		
        if( tasks != null ){
       		if( tasks.length > 8 ){
	   			tasks = tasks.slice( 0, 8 );
	   		}

	   		vnTaskFactory.assembleTasks( tasks );
			$scope.$apply( function(){
				$scope.taskreminders = tasks;
				$scope.patientcentric = false;
			});
        }
      };
})
.factory('vnTaskFactory', function( 
	visionFactory,
	$rootScope,
	$mdToast ){
	var factory = {};
	factory.TASK_UPDATED = "TASK_UPDATED";

	chrome.runtime.onMessage.addListener(
	  function(response, sender, sendResponse) {
	    taskEventBroadcast( factory.TASK_UPDATED, response.task );
	    angular.forEach( response.task.assignee, function( value, index ){
 			if( $rootScope.user.id == value ){
 				$mdToast.show($mdToast.simple().content('New task received').position("bottom right"));
 			}
 		});
	});

	var taskEventBroadcast = function( eventName, task ){
		$rootScope.$broadcast( eventName, task );
		
	};

	factory.registerTaskEventListener = function( eventName, callback ){
		$rootScope.$on( eventName, callback)
	};

	factory.assembleTasks = function( tasks ){
		
		angular.forEach( tasks, function( value, index ){
			if( value.patient == null ){
				value.patientdisplay = null;
			}else{
				value.patientdisplay = value.patient.Surname.toUpperCase() + ", " + value.patient.Forename + " (" + value.patient.DOB + ")";
			}
		});
	}

	factory.sendTask = function( task, callback ){
		visionFactory.updateData( database[ TASK ].name,
			task,
			function( returnedTask ){
				if( callback != null ){
					callback( returnedTask );
				}
				
				taskEventBroadcast( factory.TASK_UPDATED, returnedTask );
				chrome.runtime.sendMessage( { task: returnedTask }, function() {});
				
			} 
		);
	};

	factory.retrieveTasksFor = function( assigneeId, callback ){
		var index = 'by_id';
		var bounds = null;

		
		var item1 = {};
		item1.item = database[ TASK ].name;
		item1.bounds = {start: assigneeId, end: assigneeId };
		item1.index = "by_assignee";
		item1.count = 100;


		var item2 = {};
		item2.item = database[ CLINICAL_DOCS ].name;
		item2.count = 100;

		visionFactory.retrieveDataWithJoin( [ item1, item2 ], ["clinicaldocid", "id"],
			function( tasks ){
				if( tasks == null || tasks.length < 1 ){
					callback( tasks );
					return;
				}
				/* Wanted to use promises here but unable to pass > 1 arg to the next function */
				visionFactory.retrieveDataAggregateWithResults( tasks, "patient", database[PATIENT].name, { start: "clinicaldocs.patientid", end:  "clinicaldocs.patientid" },
				function( resultsWithDocs ){
					visionFactory.retrieveDataAggregateWithResults( resultsWithDocs, "subject", database[TASK_SUBJECTS].name, { start: "subjectid", end:  "subjectid" },
					function( resultsWithSubject ){
						visionFactory.retrieveDataAggregateWithResults( resultsWithSubject, "patient", database[PATIENT].name, { start: "patientid", end:  "patientid" },
						function( results ){
							callback( results );
						});
					});
				});
			}
		);
	};
	return factory;
})
.directive('vnTask', function() {
    return {
      restrict: 'E',
      scope: {
      	patientspecific: '@vnPatientSpecific',
      	screenToWatch: '@vnWatch'
      },
      templateUrl: 'apps/components/tasks/vntask.html'
    };
  });