angular.module('vnWorkflowTrackingModule', [],function () {})
.controller('vnWorkflowTrackingController', function( 
  $scope, 
  $rootScope, 
  vnNavigationFactory, 
  vnTrackingFactory ){
  
  $scope.informCommands = trackingInformCommands;

  $scope.initTracking = function () {
    $scope.$watch( 
      "screens.VN_TASK__TRACKING", function( value ){
        if( value ){
          handleShow();
        }
      });
  };

  var handleShow = function(){
    $scope.track = vnTrackingFactory.getTracking();
  };

	$rootScope.$on( "INFORM_COMMAND_SELECTED", function( scope, value ){
  		if( value == TRKSVE ){
        vnTrackingFactory.setTracking( $scope.track );
  			vnNavigationFactory.switchScreens( vnNavigationFactory.retrieveScreenFromHistory ( vnNavigationFactory.SCREEN_PREVIOUS ) );
  		}else if( value == TRKCNL ){
  			vnNavigationFactory.switchScreens( vnNavigationFactory.retrieveScreenFromHistory ( vnNavigationFactory.SCREEN_PREVIOUS ) );
  		}
  	});
})
.factory( "vnTrackingFactory", function( $rootScope ){
  /* SETTING UP TRACKING, USED ON WORKFLOW SCREEN */
  var factory = {};
  var tracking;
  
  factory.TRACKING_UPDATED = "TRACKING_UPDATED";

  factory.clearTracking = function(){
     factory.setTracking(initGeneralTracking());
  };

  factory.setTracking = function( value ){
    tracking = value;
    $rootScope.$broadcast( factory.TRACKING_UPDATED );
  };

  factory.getTracking = function(){
    if( tracking == null ){
      tracking = initGeneralTracking();
    }
    return tracking;
  };

  factory.hasTracking = function(){
    var hasTracking = false;
    angular.forEach( factory.getTracking(), function( trackValue, trackIndex ){
      if( trackValue.selected != null && trackValue.selected == true ){
        hasTracking = true;
      }
    });
    return hasTracking;
  };

  var initGeneralTracking = function(){
    return {
        assigneeChange: { selected: false, label: "assignees", type: "t" },
        commentChange: { selected: false, label: "comments", type: "t" },
        statusChange: { selected: false, label: "status", type: "t", trackingevent: "TASK_STATUS_TRACKING" },
        complete: { selected: false, label: "complete", type: "t" },
        idle: { selected: false, label: "idle time", type: "p" },
        idleTime: { value: "", label: "", type: "p" },
      };
  };

  return factory;

})
.directive('vnTracking', function() {
    return {
      restrict: 'E',
      templateUrl: 'apps/visiontasks/workflow/vntracking.html'
    };
});


