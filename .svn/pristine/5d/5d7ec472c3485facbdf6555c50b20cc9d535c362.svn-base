angular.module('vnDetailViewModule', [],function () {})
.factory('vnDetailViewFactory', function( $rootScope ){
	var factory = {};
	var model;

	factory.setModel = function( value ){
		model = value
		$rootScope.$broadcast( "DETAIL_VIEW_UPDATED" );
	};

	factory.getModel = function(){
		return model;
	};

	factory.clearModel = function(){
		factory.setModel({});
	};
	factory.clearModel();

	return factory;
})
.controller('vnDetailViewController', function ( 
	$scope,
	$rootScope,
	$timeout,
	visionFactory,
	vnTaskFactory,
	vnCommentsFactory,
	vnActionFactory,
	vnScrollFactory,
	vnDetailViewFactory,
	vnAnnouncementsFactory,
	vnScreenManagementFactory) {

	$rootScope.$on( vnScreenManagementFactory.GENERAL_CLICK, function( event ){
		closeDialog();
	});

	$rootScope.$on( "DETAIL_VIEW_UPDATED", function(){
		vnCommentsFactory.setCommentsId( vnDetailViewFactory.getModel().commentsid );
		retrieveData();
	});

	var retrieveData = function(){
		var model = vnDetailViewFactory.getModel();
		//Bit of task specific stuff here
		if( model != null && model.workflowid != null ){
			visionFactory.retrieveData( database[ TASK_WORKFLOW ].name, function( workflow ){
				workflow = workflow[0];
				var count = 0;
				angular.forEach( workflow.tasks, function( task, taskIndex ){
					count += task.length; 
				});
				model.taskCount = count;
				$scope.model = model;
				$scope.$apply();
				initialiseCommentCount();
			}, null, { start: model.workflowid, end: model.workflowid });
		}else{
			$scope.model = model;
			initialiseCommentCount();
		}
		
	};

	var initialiseCommentCount = function(){
		
		visionFactory.retrieveData( database[ COMMENTS ].name, function( comments ){
			comments = comments[0];
			
			if( comments == null || comments.comments.length < 1 ){
				
				$timeout( function(){
					$scope.model.commentscount = 0;
				} );
			}else{
				$timeout( function(){
					$scope.model.commentscount = comments.comments.length;
				} );
			}
		}, null, {start: $scope.model.commentsid, end: $scope.model.commentsid} );
	};

	$rootScope.$on( "COMMENTS_UPDATED", function(){
		retrieveData();
	});

	

	$scope.init = function () {

	};

	
	var handleShow = function(){
		
	};

	var closeDialog = function(){
		var detailView = $( ".menu.detail-view" );
		if( detailView.hasClass( "open" ) ){
			detailView.removeClass( "open" );
			detailView.attr( "style", "" );
			vnScrollFactory.enableScrolling();
		}
		//vnCommentsFactory.clearCommentsId();
	};

	$scope.handleWorkflowClick = function(){
		vnActionFactory.needHelpWith( vnActionFactory.GENERAL, [ this.model ], function(){});
		closeDialog();
	};

	$scope.handleGeneralClick = function( event ){
		if( event != null ){
	      	event.stopPropagation();
	    }
	};

	
}).directive('vnDetailView', function() {
	return {
	  restrict: 'E',
	  templateUrl: 'apps/components/dialog/vndetailview.html'
	};
});