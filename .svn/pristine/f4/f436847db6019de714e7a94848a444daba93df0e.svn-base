angular.module('vnTaskModule', [],function () {})
.controller('vnTaskController', function ( 
	$scope, 
	$rootScope,
	$timeout,
	visionFactory, 
	vnActionFactory,
	visionFactory,
	vnTaskFactory,
	vnTaskCreateFactory,
	vnScreenManagementFactory,
	vnNavigationFactory,
	vnActivitiServiceFactory
	) {


	$scope.init = function ( callback ) {
		$rootScope.$watch( $scope.screenToWatch, function( value ){
			if( value ){
				handleShow();
	    	}
      	});
		vnTaskFactory.registerTaskEventListener( vnTaskFactory.TASK_UPDATED, function( event, task ){
			handleTaskUpdated( task );
	 	});

	 	
	};

	$( window ).resize(function() {
        handleResize();
      });

	var handleResize = function(){
		$timeout( function(){
			$('.tasks-cat .tasks').each(function( index ) {
			    var children = $( this ).children();
			    var lastChild = children.last();
			    var firstChild = $( children[ 1 ] );
			    if( firstChild.position().left != lastChild.position().left  ){
			    	$(this).width('55em');
			    }else{
			    	$(this).width('30em');
			    }
			    
			});
		}, 100);
    };

	

	$scope.handleActionClick = function( action ){
		if( !vnScreenManagementFactory.isDoubleClick() ){
			if( action.id == CRDACN ){
				vnActionFactory.needHelpWith( this.task.subject.actiontypeid, [this.task], function(){});
			}else if( action.id == CRDCLM ){
				this.task.status = vnTaskFactory.PENDING;
				this.task.assignee = [ $rootScope.user.id ];
				vnTaskFactory.updateTask( this.task, function(){});
			}
		}
	}

	$scope.getCardActions = function(){
		return vnTaskFactory.actions[ this.task.status ];
	};

	var handleTaskUpdated = function( task ){
		//angular.forEach( task.assignee, function( value, index ){
			if( $rootScope.user != null ){
				vnTaskFactory.retrieveTasksFor( $rootScope.user.id, handleTasksRetrieved );
			}
 		//});
	};

	var handleShow = function(){
		vnTaskFactory.retrieveTasksFor( $rootScope.user.id, handleTasksRetrieved );
	};

	$scope.handleRightClick = function( event, element ){
		vnScreenManagementFactory.handleItemClick( event, element, {}, taskRightCommands, true );
	};

	$scope.handlePatientClick = function( event ){
        visionFactory.handlePatientClick( this.item.patient.id );
        event.stopPropagation();
	};

	$scope.handleAddClick = function( event ){
		if( !vnScreenManagementFactory.isDoubleClick() ){
			//vnNavigationFactory.switchScreens( 'home', 'taskform' );
			
		}
	};

	$scope.handleCardClick = function(){
		if( !vnScreenManagementFactory.isDoubleClick() ){
			var task = this.task;
			var due = null;
			if( task.due != null ){
				due = moment( task.due ).toDate();
			}

			vnTaskCreateFactory.setModel({
				task: task,
				selectedRecipients: task.assigneefull,
				selectedSubjects: task.subjectid,
				description: task.description,
				urgency: task.urgency,
				due: due,
				isAnnouncement: task.announcement
			});
			vnScreenManagementFactory.openMenu( ".vision-reception .tasks-cat .task-create" );
		}
	};

	var handleTasksRetrieved = function( tasks ){
		
        if( tasks != null ){
       		if( tasks.length > 8 ){
	   			tasks = tasks.slice( 0, 8 );
	   		}

	   		vnTaskFactory.assembleTasks( tasks );

			$scope.$apply( function(){
				$scope.taskreminders = tasks;
				$scope.patientcentric = false;
			});
			handleResize();
        }
      };
})
.factory('vnTaskFactory', function( 
	visionFactory,
	$rootScope,
	$mdToast ){
	var factory = {};
	factory.TASK_UPDATED = "TASK_UPDATED";

	factory.PENDING = 0;
	factory.CLAIMABLE = 1;
	factory.actions = {};
	factory.actions[ factory.PENDING ] = defaultCard;
	factory.actions[ factory.CLAIMABLE ] = [ claimAction ];

	chrome.runtime.onMessage.addListener(
	  function(response, sender, sendResponse) {
	    taskEventBroadcast( factory.TASK_UPDATED, response.task );
	    angular.forEach( response.task.assignee, function( value, index ){
 			if( $rootScope.user.id == value ){
 				$mdToast.show($mdToast.simple().content('New task received').position("bottom right"));
 			}
 		});
	});

	factory.buildTask = function( assignees, subjectid, description, clinicaldocid, patientid, clinicaldoclocal, urgency, isAnnouncement, due, id ){
		
		var assigneeIds = [];
		var status = factory.PENDING;
		
		if( urgency == null ){
			urgency = "Routine";
		}

		//Assuming that this is a lone task being sent
		if( id == null ){
			id = 0;
		}

		angular.forEach( assignees, function( value, index ){
			// If it's a group of users
			if( value.users != null  ){
				assigneeIds = assigneeIds.concat( value.users );
			}else{
				assigneeIds.push( value.id );
			}
		});

		// Remove duplicates
		var assigneeMap = {};
		angular.forEach( assigneeIds, function( value, index ){
			assigneeMap[ value ] = value;
		} );
		
		assigneeIds = [];

		for (var assigneeValue in assigneeMap) {
		    assigneeIds.push( assigneeMap[ assigneeValue ] );
		}
		

		if( assigneeIds != null && assigneeIds.length > 1 ){
			status = factory.CLAIMABLE;
		}
		

		var task = { 
			id: id,	
			assignee: assigneeIds,
			assigneefull: assignees,
			assigner: {id: $rootScope.user.id, displayname: $rootScope.user.shortlabel, displaynamelong: $rootScope.user.label},
			clinicaldocid: clinicaldocid,
			clinicaldoc: clinicaldoclocal,
			description: description,
			due: due,
			image: "task_pad.svg",
			overduealert: "false",
			patientid: 78,
			priority: "2",
			private: "false",
			recurrence: "false",
			status: status,
			statusimage: "Did_not_arrive2.png",
			subject: null,
			subjectid: subjectid,
			urgency: urgency,
			announcement: isAnnouncement
		};

		return task;
	};

	var taskEventBroadcast = function( eventName, task ){
		$rootScope.$broadcast( eventName, task );
	};

	factory.registerTaskEventListener = function( eventName, callback ){
		$rootScope.$on( eventName, callback)
	};

	factory.assembleTasks = function( tasks ){
		
		angular.forEach( tasks, function( value, index ){
			if( value.patient == null ){
				value.patientdisplay = null;
			}else{
				value.patientdisplay = value.patient.Surname.toUpperCase() + ", " + value.patient.Forename + " (" + value.patient.DOB + ")";
			}

			if( value.status == factory.CLAIMABLE ){

			}
		});
	}

	factory.updateTask = function( task, callback ){
		visionFactory.updateData( database[ TASK ].name, task, function( returnedTask ){
			if( returnedTask ){
				taskEventBroadcast( factory.TASK_UPDATED, returnedTask );
				chrome.runtime.sendMessage( { task: returnedTask }, function() {});
				if( callback != null ){
					callback( returnedTask );
				}
			}
		});
	};

	factory.sendTask = function( task, callback, onSuccessShowToast, customMessage ){
		factory.updateTask( task, function( returnedTask ){
			if( callback != null ){
				callback( returnedTask );
			}
			
			if( onSuccessShowToast == null || onSuccessShowToast == true ){
				if( customMessage == null ){
					customMessage = 'Task sent successfully';
				}
				$mdToast.show( $mdToast.simple().content( customMessage ).position("bottom right") );
			}
		});
	};

	factory.retrieveTasksFor = function( assigneeId, callback ){
		var index = 'by_id';
		var bounds = null;

		
		var item1 = {};
		item1.item = database[ TASK ].name;
		item1.bounds = {start: assigneeId, end: assigneeId };
		item1.index = "by_assignee";
		item1.count = 100;


		var item2 = {};
		item2.item = database[ CLINICAL_DOCS ].name;
		item2.count = 100;

		visionFactory.retrieveDataWithJoin( [ item1, item2 ], ["clinicaldocid", "id"],
			function( tasks ){
				if( tasks == null || tasks.length < 1 ){
					callback( tasks );
					return;
				}
				/* Wanted to use promises here but unable to pass > 1 arg to the next function */
				visionFactory.retrieveDataAggregateWithResults( tasks, "patient", database[PATIENT].name, { start: "clinicaldocs.patientid", end:  "clinicaldocs.patientid" },
				function( resultsWithDocs ){
					visionFactory.retrieveDataAggregateWithResults( resultsWithDocs, "subject", database[TASK_SUBJECTS].name, { start: "subjectid", end:  "subjectid" },
					function( resultsWithSubject ){
						visionFactory.retrieveDataAggregateWithResults( resultsWithSubject, "patient", database[PATIENT].name, { start: "patientid", end:  "patientid" },
						function( results ){
							callback( results );
						});
					});
				});
			}
		);
	};
	return factory;
})
.directive('vnTask', function() {
    return {
      restrict: 'E',
      scope: {
      	patientspecific: '@vnPatientSpecific',
      	screenToWatch: '@vnWatch'
      },
      templateUrl: 'apps/components/tasks/vntask.html'
    };
  });