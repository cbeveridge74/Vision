angular.module('vnTaskCreateModule', [],function () {})
.directive('vnTaskCreate', function() {
    return {
      restrict: 'E',
      controller:  function ( 
			$scope, 
			$rootScope,
			$mdToast,
			$timeout,
			visionFactory,
			vnTaskFactory,
			vnScreenManagementFactory,
			vnNavigationFactory,
			vnWorkflowFactory,
			VN_TASK_SCREENS
			){

			$scope.recipientCollection = [];
			var initModel = function(){
				$scope.model = { 
					selectedRecipients: [],
					selectedSubjects: -1,
					description: "",
					urgency: "Routine",
					dueDate: null,
					isAnnouncement: false
				};
			};

			if( $scope.model == null ){
				initModel();
			}

			var minimiseAllCards = function(){
				$scope.dueDateLabel = moment( $scope.model.dueDate ).format( "YYYY-MM-DD" );
				createRecipientsLabel();
      			vnWorkflowFactory.minimiseAllCards();
      		};

      		var createRecipientsLabel = function(){
      			$scope.recipientsLabel = "";
				angular.forEach( $scope.model.selectedRecipients, function( value, index ){
					$scope.recipientsLabel += value.title + ", ";
				});
				$scope.recipientsLabel = $scope.recipientsLabel.substring( 0, $scope.recipientsLabel.length - 2 );
      		};


			$scope.init = function ( callback ) {
				
				$rootScope.$watch( "screens." + VN_TASK_SCREENS.TASK_CREATE, function( value ){
					if( value ){
						handleShow();
			    	}
		      	});

		      	$rootScope.$on( vnScreenManagementFactory.GENERAL_CLICK, function( event, clickEvent ){

		      		if( clickEvent == null ||
		      			clickEvent.target.tagName == "BUTTON" || 
		      			clickEvent.target.tagName == "MD-ICON" ){
		      			return;
		      		}
	      			if( !$scope.minimise && minCriteria() ){
	      				minimiseAllCards();
	      			}
	      		});

				$scope.dueDateLabel = "No due date"
				createRecipientsLabel();
		      	
				$scope.$watch( 'model.selectedRecipients', function(){
					handleMinFieldsChange();
					createRecipientsLabel();
				}, true );

				$scope.$watch( 'model.selectedSubjects', function(){
					handleMinFieldsChange();
				}, true );

				var handleMinFieldsChange = function(){
					$scope.mincriteriaachieved = minCriteria();
					if( $scope.minimumFieldsSatisfiedCallback != null ){
						$scope.minimumFieldsSatisfiedCallback( {isSatisfied: minCriteria()} );
						$rootScope.$broadcast( "TASK_MIN_FIELDS_SATISFIED", $scope.mincriteriaachieved );
					}
				};

				var minCriteria = function(){
					if( $scope.model == null || $scope.model.selectedRecipients == null || $scope.model.selectedSubjects == null){
						return false;
					}
					return $scope.model.selectedRecipients.length > 0 && $scope.model.selectedSubjects > 0;
				};

				$scope.mincriteriaachieved = minCriteria();

				visionFactory.retrieveData( database[ TASK_SUBJECTS ].name, function( result ){
					$scope.subjectCollection = result;
				});
				
			};

			$scope.handleCalendarClick = function( event ){
				
			};

			$scope.handleAnnouncementClick = function( event ){
				$scope.model.isAnnouncement = !$scope.model.isAnnouncement;
			};

			$scope.handleGeneralClick = function( event ){
				if( event != null ){
			      	event.stopPropagation();
			    }
			};


			/* NOTE: this is only used on the workflow screen  */
			$scope.handleDeleteClick = function( idx, outerBoxIdx ){
				vnWorkflowFactory.deleteTaskCard( idx, outerBoxIdx );
			};

			$scope.handleAddClick = function( outerBoxIdx ){
				minimiseAllCards();
			};

			$scope.handleEditClick = function( idx, outerBoxIdx, e ){
				if( $scope.minimise ){
					minimiseAllCards();
					vnWorkflowFactory.restoreCard( idx, outerBoxIdx );
				}
			};

			
			$scope.handleAdvancedClick = function( event ){
				vnWorkflowFactory.clearWorkflow();
				vnWorkflowFactory.initialiseWorkflowWithModel({ 
					selectedRecipients: $scope.model.selectedRecipients,
					selectedSubjects: $scope.model.selectedSubjects,
					description: $scope.model.description,
					urgency: $scope.model.urgency,
					dueDate: $scope.model.dueDate,
					isAnnouncement: $scope.model.isAnnouncement   
				}, false);//Don't minimise it.
				$scope.handleCancelClick();
				vnNavigationFactory.switchScreens( VN_TASK_SCREENS.WORKFLOW );
			};

			$scope.handleCancelClick = function( event ){

				vnScreenManagementFactory.closeMenus();
				initModel();
				$scope.dueDateLabel = "No due date";
			};

			$scope.handleSaveClick = function( event ){

				
				var task = vnTaskFactory.buildTask( 
					$scope.model.selectedRecipients, 
					$scope.model.selectedSubjects, 
					$scope.model.description, 
					-1, 
					78 );

				vnWorkflowFactory.convertTaskToWorkflow( task, function( workflowedTask ){
					vnWorkflowFactory.saveWorkflow ( workflowedTask, function(){
						vnWorkflowFactory.beginWorkflow( workflowedTask.name );
						$scope.handleCancelClick();
					});
				});

			};

			var handleShow = function(){

				
			};
	  },
      scope: {
      	minimumFieldsSatisfiedCallback: "&minimumFieldsSatisfiedHandler",
      	model: "=",
      	minimise: "="
      },
      require: 'model',
      templateUrl: 'apps/visiontasks/workflow/vntaskcreate.html'
    };
  });